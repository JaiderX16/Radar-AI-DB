<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot IA - Lugares de Huancayo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a1a1a',
                        secondary: '#333333',
                        accent: '#4a90e2'
                    }
                }
            }
        }
    </script>
    <style>
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* Scrollbar personalizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Estilos para las tarjetas de imagen */
        .image-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .image-container img {
            transition: transform 0.3s ease;
        }
        
        .image-container:hover img {
            transform: scale(1.05);
        }
        
        /* Dashboard styles */
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .category-filter {
            transition: all 0.2s ease;
        }
        
        .category-filter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .category-filter.active {
            background: #4a90e2;
            color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-primary text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Chatbot IA - Lugares de Huancayo</h1>
                    <p class="text-gray-300 text-sm">Descubre lugares turísticos con inteligencia artificial</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="newChat()" class="bg-secondary hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nuevo Chat
                    </button>
                </div>
            </div>
        </div>
    </header>



    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Chat Section -->
            <div class="lg:col-span-2">
                <!-- Chat Container -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <!-- Chat Header -->
                    <div class="bg-primary text-white px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-xl font-semibold">Chat con IA</h2>
                                <p class="text-gray-300 text-sm">Gemini - Información turística</p>
                            </div>
                            <div class="flex items-center space-x-2">
                            <span class="bg-green-500 w-3 h-3 rounded-full"></span>
                            <span class="text-sm">En línea</span>
                        </div>
                    </div>
                </div>

                    <!-- Messages -->
                    <div class="h-96 overflow-y-auto custom-scrollbar p-6" id="messages">
                        <div class="flex items-start space-x-3 mb-4 fade-in">
                            <div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">
                                IA
                            </div>
                            <div class="bg-gray-100 rounded-lg px-4 py-3 max-w-xs lg:max-w-md">
                                <p class="text-gray-800">¡Hola! Soy tu asistente de IA con información sobre lugares turísticos en Huancayo.</p>
                                <p class="text-gray-800 mt-2">¿Qué te gustaría conocer?</p>
                            </div>
                        </div>
                    </div>

                    <!-- Input Container -->
                    <div class="border-t bg-gray-50 px-6 py-4">
                        <div class="flex space-x-4">
                            <input type="text" id="message-input" placeholder="Escribe tu pregunta sobre lugares en Huancayo..." 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent">
                            <button onclick="sendMessage()" id="send-button" 
                                    class="bg-accent hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <!-- Quick Suggestions -->
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button onclick="sendSuggestion('Que parques hay en Huancayo?')" 
                                    class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors">
                                Parques
                            </button>
                            <button onclick="sendSuggestion('Donde puedo ir con ninos?')" 
                                    class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm hover:bg-green-200 transition-colors">
                                Familia
                            </button>
                            <button onclick="sendSuggestion('Que lugares son gratis?')" 
                                    class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm hover:bg-yellow-200 transition-colors">
                                Gratis
                            </button>
                            <button onclick="sendSuggestion('Donde puedo comer?')" 
                                    class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm hover:bg-red-200 transition-colors">
                                Comida
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- LUGARES DESTACADOS - NUEVA SECCIÓN EN PANTALLA PRINCIPAL -->
                <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-map-marker-alt mr-2 text-green-500"></i>Lugares Destacados en Huancayo
                        </h3>
                    </div>
                    
                    <!-- Lista de lugares en pantalla principal -->
                    <div id="main-places-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                        <!-- Los lugares se cargarán aquí dinámicamente -->
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-map-marked-alt text-4xl mb-2"></i>
                            <p>Cargando lugares de Huancayo...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Quick Actions & Info -->
            <div class="space-y-6">
                <!-- Quick Stats -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-chart-line mr-2 text-blue-500"></i>Estadísticas Rápidas
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Lugares activos:</span>
                            <span id="sidebar-places-count" class="font-bold text-blue-600">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Chats hoy:</span>
                            <span id="sidebar-chats-count" class="font-bold text-green-600">-</span>
                        </div>
                    </div>
                </div>

                <!-- Help Section -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        ¿Cómo usar?
                    </h3>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p>• Escribe preguntas sobre lugares en Huancayo</p>
                        <p>• Usa los filtros para búsquedas específicas</p>
                        <p>• Haz clic en "Nuevo Chat" para empezar de nuevo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        var conversationHistory = [];
        var currentCategory = null;
        
        // Función para actualizar estadísticas básicas del sidebar
        function updateSidebarStats() {
            fetch('/api/stats')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    // Actualizar solo el sidebar
                    document.getElementById('sidebar-places-count').textContent = data.total_lugares;
                    document.getElementById('sidebar-chats-count').textContent = data.chats_hoy;
                })
                .catch(function(error) {
                    console.error('Error al actualizar estadísticas:', error);
                });
        }
        
        // Función para cargar lugares en la pantalla principal
        function loadMainPlaces(category) {
            if (category === undefined) category = null;
            console.log('=== LOADMAINPLACES INICIADO ===');
            console.log('Categoria:', category);
            
            var url = '/api/places';
            var params = new URLSearchParams();
            if (category) params.append('category', category);
            if (params.toString()) url += '?' + params.toString();
            
            console.log('Llamando a:', url);
            fetch(url)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('Datos recibidos para pantalla principal:', data);
                    
                    var mainPlacesList = document.getElementById('main-places-list');
                    console.log('Elemento mainPlacesList encontrado:', !!mainPlacesList);
                    
                    if (!mainPlacesList) {
                        console.error('No se encontro el elemento main-places-list');
                        return;
                    }
                    
                    var lugares = data.places || data.lugares || data || [];
                    console.log('Lugares procesados para pantalla principal:', lugares);
                    console.log('Numero de lugares:', lugares.length);
                    
                    renderPlaces(lugares);
                    
                    console.log('=== LOADMAINPLACES FINALIZADO ===');
                })
                .catch(function(error) {
                    console.error('=== ERROR EN LOADMAINPLACES ===');
                    console.error('Error:', error);
                    
                    var mainPlacesList = document.getElementById('main-places-list');
                    if (mainPlacesList) {
                        mainPlacesList.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Error al cargar lugares</p><p class="text-sm">Por favor, intenta nuevamente</p></div>';
                    }
                });
        }

        function renderPlaces(lugares) {
            var mainPlacesList = document.getElementById('main-places-list');
            if (!mainPlacesList) {
                console.error('No se encontro el elemento main-places-list');
                return;
            }

            if (lugares.length > 0) {
                console.log('Generando HTML para lugares...');
                var html = lugares.map(function(place) {
                    return '<div class="bg-gradient-to-br from-white to-gray-50 rounded-xl p-4 hover:shadow-lg transition-all duration-300 border border-gray-100 hover:border-green-200">' +
                        '<div class="flex items-start space-x-4">' +
                            '<div class="flex-1 min-w-0">' +
                                '<h4 class="text-lg font-bold text-gray-900 mb-1">' + (place.nombre || 'Sin nombre') + '</h4>' +
                                '<p class="text-sm text-gray-600 mb-2">' + (place.descripcion || 'Sin descripcion') + '</p>' +
                                '<div class="flex items-center space-x-2 mb-2">' +
                                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + 
                                        (place.categoria === 'parques' ? 'bg-green-100 text-green-800' : 
                                         place.categoria === 'plazas' ? 'bg-blue-100 text-blue-800' : 
                                         'bg-gray-100 text-gray-800') + '">' +
                                        (place.categoria || 'Sin categoria') +
                                    '</span>' +
                                    '<span class="text-xs text-gray-500">' + 
                                        (place.ubicacion || 'Ubicacion no especificada') + 
                                    '</span>' +
                                '</div>' +
                                (place.imagen_url ? '<img src="' + place.imagen_url + '" alt="' + place.nombre + '" class="w-full h-32 object-cover rounded-lg shadow-sm mt-2" onerror="this.style.display=\'none\'">' : '') +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
                
                mainPlacesList.innerHTML = html;
                console.log('Se renderizaron', lugares.length, 'lugares');
            } else {
                mainPlacesList.innerHTML = '<div class="text-center py-12 text-gray-500"><i class="fas fa-search text-5xl mb-4 opacity-50"></i><p class="text-lg">No se encontraron lugares</p><p class="text-sm mt-1">Intenta con otra categoria o busqueda</p></div>';
            }
        }
        
        // Función para mostrar todos los lugares
        function showAllPlaces(event) {
            currentCategory = null;
            
            // Actualizar UI de botones
            document.querySelectorAll('.category-filter').forEach(function(btn) {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Actualizar lista de lugares en la pantalla principal
            loadMainPlaces();
        }
        
        // Función para nuevo chat
        function newChat() {
            // Limpiar historial de conversacion
            conversationHistory = [];
            currentCategory = null;
            
            // Limpiar mensajes
            var messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '<div class="flex items-start space-x-3 mb-4 fade-in">' + 
                '<div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">' + 
                    'IA' + 
                '</div>' + 
                '<div class="bg-gray-100 rounded-lg px-4 py-3 max-w-xs lg:max-w-md">' + 
                    '<p class="text-gray-800">Hola! Soy tu asistente de IA con informacion sobre lugares turisticos en Huancayo.</p>' + 
                    '<p class="text-gray-800 mt-2">Que te gustaria conocer?</p>' + 
                '</div>' + 
            '</div>';
            
            // Limpiar UI de botones
            document.querySelectorAll('.category-filter').forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Mostrar todos los lugares por defecto
            setTimeout(function() {
                showAllPlaces(null);
            }, 1000);
        }
        
        // Función para enviar mensaje
        function sendMessage() {
            var input = document.getElementById('message-input');
            var message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            // Ya no detectamos categorías manualmente, la IA lo hará automáticamente
            showTypingIndicator();
            
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    auto_filter: true // Indicamos al backend que queremos filtrado automático
                })
            })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    hideTypingIndicator();
                    
                    if (data.category) {
                        currentCategory = data.category;
                        // Actualizar botones activos
                        document.querySelectorAll('.category-filter').forEach(function(btn) {
                            btn.classList.remove('active');
                            if (btn.dataset.category === data.category || 
                                (data.category === 'todos' && btn.onclick.toString().includes('todos'))) {
                                btn.classList.add('active');
                            }
                        });
                        
                        // Si la IA detectó una categoría, actualizar la vista
                        if (data.category === 'todos') {
                            loadMainPlaces();
                        } else {
                            loadMainPlaces(data.category);
                        }
                    }
                    
                    if (data.places && data.places.length > 0) {
                        renderPlaces(data.places);
                    }
                    
                    if (data.response) {
                        addMessage(data.response, 'bot');
                        conversationHistory.push({
                            user: message,
                            bot: data.response
                        });
                    } else {
                        addMessage('Lo siento, ocurrió un error al procesar tu mensaje.', 'bot');
                    }
                })
                .catch(function(error) {
                    console.error('Error al enviar mensaje:', error);
                    hideTypingIndicator();
                    addMessage('Lo siento, ocurrió un error al procesar tu mensaje. Por favor, intenta nuevamente.', 'bot');
                });
        }
        
        // FunciÃ³n para enviar sugerencia
        function sendSuggestion(suggestion) {
            document.getElementById('message-input').value = suggestion;
            sendMessage();
        }
        
        // FunciÃ³n para agregar mensaje
        function addMessage(text, sender) {
            var messagesContainer = document.getElementById('messages');
            var messageDiv = document.createElement('div');
            messageDiv.className = "flex items-start space-x-3 mb-4 fade-in " + (sender === 'user' ? 'flex-row-reverse space-x-reverse' : '');
            
            // Formatear el texto (convertir markdown a HTML)
            var formattedText = formatResponse(text);
            
            messageDiv.innerHTML = '<div class="' + (sender === 'user' ? 'bg-accent text-white' : 'bg-primary text-white') + ' w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">' + (sender === 'user' ? 'Tu' : 'IA') + '</div>' + '<div class="' + (sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800') + ' rounded-lg px-4 py-3 max-w-xs lg:max-w-md">' + formattedText + '</div>';
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // FunciÃ³n para formatear respuestas (markdown a HTML)
        function formatResponse(text) {
            // Convertir imÃ¡genes markdown a HTML
            text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, function(match, alt, src) {
                return '<img src="' + src + '" alt="' + alt + '" class="response-image rounded-lg cursor-pointer hover:opacity-90 transition-opacity" onclick="openImageModal(\'' + src + '\', \'' + alt + '\')">'; 
            });
            
            // Convertir negritas
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-bold">$1</strong>');
            
            // Convertir cursivas
            text = text.replace(/\*([^*]+)\*/g, '<em class="italic">$1</em>');
            
            // Convertir enlaces
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-blue-600 hover:text-blue-800 underline">$1</a>');
            
            // Convertir listas
            text = text.replace(/^\* (.+)$/gm, '<li class="ml-4">$1</li>');
            if (text.includes('<li>')) {
                text = '<ul class="list-disc space-y-1">' + text + '</ul>';
            }
            
            // Convertir saltos de lÃ­nea
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // FunciÃ³n para mostrar indicador de escritura
        function showTypingIndicator() {
            var messagesContainer = document.getElementById('messages');
            var typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex items-start space-x-3 mb-4';
            typingDiv.innerHTML = '<div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">IA</div><div class="bg-gray-100 rounded-lg px-4 py-3"><div class="flex space-x-1"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div></div>';
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // FunciÃ³n para ocultar indicador de escritura
        function hideTypingIndicator() {
            var typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // FunciÃ³n para abrir modal de imagen
        function openImageModal(src, alt) {
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 cursor-pointer';
            modal.innerHTML = '<div class="bg-white rounded-lg max-w-4xl max-h-full overflow-hidden">' + 
                    '<div class="flex justify-between items-center p-4 border-b">' + 
                        '<h3 class="text-lg font-semibold">' + alt + '</h3>' + 
                        '<button onclick="this.closest(\'.fixed\').remove()" class="text-gray-500 hover:text-gray-700">' + 
                            '<i class="fas fa-times"></i>' + 
                        '</button>' + 
                    '</div>' + 
                    '<div class="p-4">' + 
                        '<img src="' + src + '" alt="' + alt + '" class="max-w-full max-h-96 object-contain rounded-lg">' + 
                    '</div>' + 
                '</div>';
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // Event listeners
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            showAllPlaces(null);
            updateSidebarStats();
            
            // Actualizar estadísticas cada 30 segundos
            setInterval(updateSidebarStats, 30000);
        });
    </script>
</body>
</html>
